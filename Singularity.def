Bootstrap: docker
From: ubuntu:22.04

%labels
    Author yourname
    Description SNAP + sarpyx runtime container

%environment
    export DEBIAN_FRONTEND=noninteractive
    export TZ=Etc/UTC

    export JAVA_HOME="/usr/lib/jvm/java-8-openjdk-amd64"
    export SNAP_HOME="/usr/local/snap"
    export SNAP_SKIP_UPDATES=1

    export PATH="${PATH}:${SNAP_HOME}/bin"

    export PIP_DISABLE_PIP_VERSION_CHECK=1
    export PIP_NO_CACHE_DIR=1

%files
    support/snap-install.sh   /tmp/snap-install.sh
    support/snap.varfile      /tmp/snap.varfile
    pyproject.toml            /workspace/pyproject.toml
    sarpyx                    /workspace/sarpyx
    entrypoint.sh             /usr/local/bin/entrypoint.sh

%post
    set -e

    apt-get update && apt-get install -y --no-install-recommends \
        ca-certificates \
        curl \
        wget \
        git \
        build-essential \
        python3.11 \
        python3.11-venv \
        python3.11-dev \
        openjdk-8-jdk \
        gdal-bin \
        libgdal-dev \
        && rm -rf /var/lib/apt/lists/*

    # Python symlinks (like your Dockerfile runtime stage)
    ln -sf /usr/bin/python3.11 /usr/bin/python3
    ln -sf /usr/bin/python3.11 /usr/bin/python

    # Install SNAP
    chmod +x /tmp/snap-install.sh
    /tmp/snap-install.sh -v
    rm -f /tmp/snap-install.sh /tmp/snap.varfile

    # Install pip for python3.11
    curl -fsSL https://bootstrap.pypa.io/get-pip.py -o /tmp/get-pip.py
    python3.11 /tmp/get-pip.py
    rm -f /tmp/get-pip.py

    # Install sarpyx
    cd /workspace
    python3.11 -m pip install --no-cache-dir .

    # Validate install
    python3.11 -c "import sarpyx; print('sarpyx installed successfully')"

    # Install entrypoint
    chmod +x /usr/local/bin/entrypoint.sh

    # Cleanup to reduce image size
    apt-get purge -y --auto-remove \
        build-essential \
        python3.11-dev \
        libgdal-dev \
        git \
        wget \
        curl \
        && apt-get clean \
        && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

%runscript
    exec /usr/local/bin/entrypoint.sh "$@"

%startscript
    exec /usr/local/bin/entrypoint.sh "$@"

%test
    python3.11 -c "import sarpyx; print('sarpyx OK')"
