// Nextflow configuration for SSM4SAR sweeps

// Global settings
manifest {
    name = 'SSM4SAR'
    description = 'State Space Models for SAR Processing'
    version = '1.0.0'
    mainScript = 'sweep.nf'
    defaultBranch = 'main'
}

// Execution profiles
profiles {
    local {
        process.executor = 'local'
        process.cpus = 4
        process.memory = '16 GB'
    }
    
    slurm {
        process.executor = 'slurm'
        process.queue = 'gpu'
        process.cpus = 8
        process.memory = '32 GB'
        process.time = '4h'
        process.clusterOptions = '--gres=gpu:1'
    }
    
    singularity {
        singularity.enabled = true
        singularity.autoMounts = true
        process.container = 'pytorch/pytorch:2.0.1-cuda11.7-cudnn8-devel'
    }
}

// Process configuration
process {
    // Default resources
    cpus = 4
    memory = '16 GB'
    time = '2h'
    
    // Error handling
    errorStrategy = 'retry'
    maxRetries = 2
    
    withName: trainModel {
        cpus = 8
        memory = '32 GB'
        time = '6h'
        clusterOptions = { workflow.profile == 'slurm' ? '--gres=gpu:1 --constraint=gpu' : '' }
    }
    
    withName: aggregateResults {
        cpus = 2
        memory = '8 GB'
        time = '30m'
    }
}

// Parameter defaults
params {
    // Sweep parameters
    learning_rates = [0.001, 0.005, 0.01]
    batch_sizes = [8, 16, 32]
    num_layers = [2, 4, 8]
    hidden_sizes = [8, 16, 32]
    activation_functions = ['relu', 'gelu', 'leakyrelu']
    ssim_proportions = [0.3, 0.5, 0.7]
    weight_decays = [0.001, 0.01, 0.1]
    
    // Fixed training parameters
    epochs = 15
    val_batch_size = 10
    gpu_no = 0
    
    // Data paths
    train_dir = '/Data_large/marine/PythonProjects/SAR/sarpyx/SSM4SAR/maya4_data/training'
    val_dir = '/Data_large/marine/PythonProjects/SAR/sarpyx/SSM4SAR/maya4_data/validation'
    
    // Output
    outdir = 'results'
    
    // Monitoring
    use_wandb = true
    wandb_project = 'ssm4sar'
}

// Resource limits
executor {
    queueSize = 10
    pollInterval = '30 sec'
}

// Reporting
report {
    enabled = true
    file = "${params.outdir}/nextflow_report.html"
}

timeline {
    enabled = true
    file = "${params.outdir}/nextflow_timeline.html"
}

trace {
    enabled = true
    file = "${params.outdir}/nextflow_trace.txt"
}

dag {
    enabled = true
    file = "${params.outdir}/nextflow_dag.svg"
}
